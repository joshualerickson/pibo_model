---
title: "lmm"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
library(latex2exp)
knitr::opts_chunk$set(dev.args = list(png = list(type = "cairo")),fig.width = 10, fig.height = 5,
                      warning = FALSE, message = FALSE, error = FALSE)
library(patchwork)
library(tidyverse)
library(GGally)
library(ggtext)
library(sasLM)
library(janitor)
library(car)
library(broom)
library(ggpubr)
library(rstatix)
library(readxl)
library(sf)
library(lme4)
library(resourceviz)
cairo_view()
thematic::thematic_on(font = 'Calibri')
source('utils.R')
library(jtools)
library(robustlmm)
library(lme4)
library(gtsummary)

```




## Linear mixed models

Get lmm for bankfull widths.

```{r}

#bring in covariates from ANCOVA

lmm_bf <- lmer(log(bf) ~ 
               log(fac_taudem_17all_int)+
               log(us_precip_1981_2010_cpg_all)+
               log(slope_percent_int_cpg_all) +
               log(us_tmax_1981_2010_int_cpg_all) +
               mgmt + 
               (1 | MAP_UNIT_N/site_id),
               gr_95_ts)

la <- list(`log(fac_taudem_17all_int)`~"log(FA Catchment Area)",
               `log(us_precip_1981_2010_cpg_all)`~"log(FA Average Annual Precipitation)",
               `log(us_tmax_1981_2010_int_cpg_all)`~"log(FA Temperature Max)",
               `log(slope_percent_int_cpg_all)`~"log(FA Basin Slope %)",
               mgmt~"Indpendent Variable")

tb_ba <- tbl_regression(lmm_bf,  label = la,
    pvalue_fun = ~style_pvalue(.x, digits = 2))%>% 
  add_global_p() %>%
  bold_p(t = 0.05) %>%
  bold_labels() %>%
  italicize_levels()


summ(lmm_bf, confint = T)
summary(lmm_bf)
lme4::vcov.merMod(lmm_bf)
#ICC 0.65 for sites and ECO and 0.09 for ECO

summary(lmm_bf)

plot(lmm_bf)

shapiro.test(residuals(lmm_bf))

qqPlot(residuals(lmm_bf))

# Run robust lmer because of the long tails in qq

rlmm_bf <- rlmer(log(bf) ~ 
               log(fac_taudem_17all_int)+
               log(us_precip_1981_2010_cpg_all)+
               log(slope_percent_int_cpg_all) + 
               log(us_tmax_1981_2010_int_cpg_all) +
               mgmt + 
               (1 | MAP_UNIT_N/site_id),
               gr_95_ts)

summ(rlmm_bf, confint = TRUE)
plot(rlmm_bf)

# play with smoothing param to make sure the weighting is not too crazy....
# default is 1.34

rlmm_list <- list() 

for(i in seq(0.5, 3, .25)){
  
  rsb <- list(psi2propII(smoothPsi, k = i), psi2propII(smoothPsi, k = i+1.5))
  rlmm_bf_it <- update(rlmm_bf, rho.sigma.b = rsb)
  
  rlmm_list <- append(rlmm_list, rlmm_bf_it)
}

rlmm_smooth_res <- compare(rlmm_bf,
                           rlmm_list[[1]],
                           rlmm_list[[2]],
                           rlmm_list[[3]],
                           rlmm_list[[4]],
                           rlmm_list[[5]],
                           rlmm_list[[6]],
                           rlmm_list[[7]],
                           rlmm_list[[8]],
                           rlmm_list[[9]],
                           rlmm_list[[10]],
                           rlmm_list[[11]],
                           show.rho.functions = FALSE)

rlmm_smooth_res

### default looks good
# little 
##### pvalues

coefs <- as.data.frame(summ(lmm_bf)$coeftable)

# get coefficients from robust model to extract t-values
coefs.robust <- coef(summary(rlmm_bf))
# calculate p-values based on robust t.values and non-robust approx. DFs
p.values <- 2*pt(abs(coefs.robust[,3]), coefs$d.f., lower=FALSE)
round(p.values,4)

```


Now for bank angle.

```{r}



lmm_ba <- lmer(log(bank_angle)~
                 log(fac_taudem_17all_int)+
                 log(ave_basin_elev)+
                 log(twi_100_int_cpg_all) + 
                 mgmt + 
                 (1 | MAP_UNIT_N/site_id),
                 gr_95_ts)

summ(lmm_ba, confint = T)

plot(lmm_ba)
ggplot() + geom_density(aes(residuals(lmm_ba)))
shapiro.test(residuals(lmm_ba))
qqPlot(residuals(lmm_ba), col = 'red')

#not too bad with outliers (when compared to bankfull). 
# still do robust analysis

#rlmmr bank angle

rlmm_ba <- rlmer(log(bank_angle)~
                 log(fac_taudem_17all_int)+
                 log(ave_basin_elev)+
                 log(twi_100_int_cpg_all) + 
                 mgmt + 
                 (1 | MAP_UNIT_N/site_id),
                 gr_95_ts)

rlmm_list <- list() 

for(i in seq(0.5, 3, .25)){
  
  rsb <- list(psi2propII(smoothPsi, k = i), psi2propII(smoothPsi, k = i+1.5))
  rlmm_bf_it <- update(rlmm_ba, rho.sigma.b = rsb)
  
  rlmm_list <- append(rlmm_list, rlmm_bf_it)
}

rlmm_smooth_res <- compare(rlmm_ba,
                           rlmm_list[[1]],
                           rlmm_list[[2]],
                           rlmm_list[[3]],
                           rlmm_list[[4]],
                           rlmm_list[[5]],
                           rlmm_list[[6]],
                           rlmm_list[[7]],
                           rlmm_list[[8]],
                           rlmm_list[[9]],
                           rlmm_list[[10]],
                           rlmm_list[[11]],
                           show.rho.functions = FALSE)

rlmm_smooth_res

### looks good with default
##### pvalues


coefs <- as.data.frame(summ(lmm_ba)$coeftable)

# get coefficients from robust model to extract t-values
coefs.robust <- coef(summary(rlmm_ba))
# calculate p-values based on robust t.values and non-robust approx. DFs
p.values <- 2*pt(abs(coefs.robust[,3]), coefs$d.f., lower=FALSE)
round(p.values,4)
```


## EMM

```{r}
library(emmeans)
library(car)

bf.rg <- ref_grid(rlmm_bf, at = list(fac_taudem_17all_int = seq(10000, 163291, 16329.1)))

emm <- plot(bf.rg, by = 'mgmt') + custom_theme()

emm_gg <- as.data.frame(emm$data) %>% tibble()


p1 <- emm_gg %>% mutate(shed_area = ifelse(mgmt %in% 'Reference', fac_taudem_17all_int+4000, fac_taudem_17all_int-4000),
                        the.emmean = exp(the.emmean),
                        lower.CL = exp(asymp.LCL),
                        upper.CL = exp(asymp.UCL)) %>% filter(the.emmean >0) %>% 
  ggplot() +
  #geom_point(data = gr_95 , aes(mean_bf, shed_areakm2, color = mgmt), size = 3, alpha = 0.2)+
  geom_errorbar(aes(the.emmean, fac_taudem_17all_int, color=mgmt,xmin = lower.CL, xmax = upper.CL),
  position = position_dodge2(width = 0.005, padding = 0.005), size = .75) + 
  custom_theme(font_size = 12) + labs(x = 'Predicted Mean Bankfull Width (m)', 
                        y = 'Watershed Area km2',
                        color = "Group",
                        title = 'Comparing estimated means by Watershed Area (km<sup>2</sup>)',
                        subtitle = 'Average annual precipitation is held constant at 1193 (mm)')  +
  geom_point(aes(the.emmean, shed_area), size = 1)
p1 




ba.rg <- ref_grid(rlmm_ba, at = list(fac_taudem_17all_int = seq(10000, 163291, 16329.1)))

emm <- plot(ba.rg, by = 'mgmt') + custom_theme()

emm_gg <- as.data.frame(emm$data) %>% tibble()


p1 <- emm_gg %>% mutate(shed_area = ifelse(mgmt %in% 'Reference', fac_taudem_17all_int+4000, fac_taudem_17all_int-4000),
                        the.emmean = exp(the.emmean),
                        lower.CL = exp(asymp.LCL),
                        upper.CL = exp(asymp.UCL)) %>% filter(the.emmean >0) %>% 
  ggplot() +
  #geom_point(data = gr_95 , aes(mean_bf, shed_areakm2, color = mgmt), size = 3, alpha = 0.2)+
  geom_errorbar(aes(the.emmean, fac_taudem_17all_int, color=mgmt,xmin = lower.CL, xmax = upper.CL),
  position = position_dodge2(width = 0.005, padding = 0.005), size = .75) + 
  custom_theme(font_size = 12) + labs(x = 'Predicted Mean Bankfull Width (m)', 
                        y = 'Watershed Area km2',
                        color = "Group",
                        title = 'Comparing estimated means by Watershed Area (km<sup>2</sup>) (without high residuals)',
                        subtitle = 'Average Basin Elevation is held constant at 1674 (m)\nTWI-CPG at 669')  +
  geom_point(aes(the.emmean, shed_area), size = 1)
p1 


```


## Look into harvest

```{r}
lmm_bf_harv <- lmer(log(bf) ~ 
                    log(fac_taudem_17all_int)+
                    log(us_precip_1981_2010_cpg_all)+
                    log(slope_percent_int_cpg_all) + 
                    harv_group + 
                    (1 | MAP_UNIT_N/site_id),
                    gr_95_ts %>% filter(mgmt == 'Managed'))

rlmm_bf_harv <- rlmer(log(bf) ~ 
                    log(fac_taudem_17all_int)+
                    log(us_precip_1981_2010_cpg_all)+
                    log(slope_percent_int_cpg_all) + 
                    harv_group + 
                    (1 | MAP_UNIT_N/site_id),
                    gr_95_ts %>% filter(mgmt == 'Managed'))

summ(lmm_bf_harv, confint = T)
summary(lmm_bf_harv)


##### pvalues


coefs <- as.data.frame(summ(lmm_bf_harv)$coeftable)

# get coefficients from robust model to extract t-values
coefs.robust <- coef(summary(rlmm_bf_harv))
# calculate p-values based on robust t.values and non-robust approx. DFs
p.values <- 2*pt(abs(coefs.robust[,3]), coefs$d.f., lower=FALSE)
round(p.values,4)


lmm_ba_harv <- lmer(log(bank_angle)~
                 log(fac_taudem_17all_int)+
                 log(ave_basin_elev)+
                 log(twi_100_int_cpg_all) + 
                 harv_group + 
                 (1 | MAP_UNIT_N/site_id),
                 gr_95_ts %>% filter(mgmt == 'Managed'))

summ(lmm_ba_harv)
ranef(lmm_ba_harv)

rlmm_ba_harv <- rlmer(log(bank_angle)~
                 log(fac_taudem_17all_int)+
                 log(ave_basin_elev)+
                 log(twi_100_int_cpg_all) + 
                 harv_group + 
                 (1 | MAP_UNIT_N/site_id),
                 gr_95_ts %>% filter(mgmt == 'Managed'))
summary(rlmm_ba_harv)

##### pvalues


coefs <- as.data.frame(summ(lmm_bf_harv)$coeftable)

# get coefficients from robust model to extract t-values
coefs.robust <- coef(summary(rlmm_bf_harv))
# calculate p-values based on robust t.values and non-robust approx. DFs
p.values <- 2*pt(abs(coefs.robust[,3]), coefs$d.f., lower=FALSE)
round(p.values,4)


```

## EMM harvest


```{r}
bf.rg_harv <- ref_grid(rlmm_bf_harv, at = list(fac_taudem_17all_int = seq(10000, 163291, 16329.1)))

emm <- plot(bf.rg_harv, by = 'harv_group') + custom_theme()

emm_gg <- as.data.frame(emm$data) %>% tibble()


p1 <- emm_gg %>% mutate(shed_area = ifelse(harv_group %in% 'Low', fac_taudem_17all_int-5000,
                                           ifelse(harv_group %in% 'Mod', fac_taudem_17all_int, fac_taudem_17all_int+5000)),
                        the.emmean = exp(the.emmean),
                        lower.CL = exp(asymp.LCL),
                        upper.CL = exp(asymp.UCL)) %>% filter(the.emmean >0) %>% 
  ggplot() +
  #geom_point(data = gr_95 , aes(mean_bf, shed_areakm2, color = mgmt), size = 3, alpha = 0.2)+
  geom_errorbar(aes(the.emmean, fac_taudem_17all_int, color=harv_group,xmin = lower.CL, xmax = upper.CL),
  position = position_dodge2(width = 0.005, padding = 0.005), size = .75) + 
  scale_y_continuous(labels = scales::comma) +
  custom_theme(font_size = 12) + labs(x = 'Predicted Mean Bankfull Width (m)', 
                        y = 'Flow Accumulated Area',
                        color = "Harvest Group",
                        title = 'Comparing Bankfull Width (m) estimated means by Flow Accumulated Area')  +
  geom_point(aes(the.emmean, shed_area), size = 1) +
  scale_color_manual(values = c('forestgreen', 'orange', 'red'))
p1 
```



```{r}
source("utils.R")
library(plotly)
library(ggh4x)
plot_facet <- list()
for(i in 1:length(unique(gr_95_ts$MAP_UNIT_N))){

plots <- gr_95_ts  %>% 
  filter(mgmt == 'Managed', 
         MAP_UNIT_N %in% unique(gr_95_ts$MAP_UNIT_N)[i]) %>% 
ggplot() + 
  geom_point(aes(yr, bf/`US_Precip_1981-2010_CPG_all`, group = site_id, color = harv_group), size = 0.25) + 
  stat_smooth(geom = 'line',aes(yr,bf/`US_Precip_1981-2010_CPG_all`, group = site_id), method = 'lm', se = F, alpha = 0.5, size = .25) +
  geom_smooth(aes(yr, bf/`US_Precip_1981-2010_CPG_all`), method = 'lm') +
  scale_y_log10() +
  facet_nested(. ~ MAP_UNIT_N+shed_cut+harv_group, 
               nest_line = element_line(linetype = 1, size = .25)) +
  custom_theme(font_size = 8) + 
  labs(x = '', y = 'BF/PR', color = 'Harvest Group')
  
plots <- list(plots)
names(plots) <- paste('p_', i)

plot_facet <- append(plot_facet, plots)

}


plot_facet[[1]]
plot_facet[[2]]
plot_facet[[3]]
plot_facet[[4]]
plot_facet[[5]]
plot_facet[[6]]


library(patchwork)

((plot_facet[[1]]|plot_facet[[2]])/
(plot_facet[[3]]|plot_facet[[4]])/
(plot_facet[[5]]|plot_facet[[6]])) + 
 plot_layout(guides = 'collect') + plot_annotation(title = 'Normalized Bankfull Width (BF/PR) across ECO-Region, Watershed Area and Harvest Group',
subtitle = 'harvest group = (0,5], (5,18], (18 +), "low", "mod", "high"')


gr_95_ts  %>% 
  filter(mgmt == 'Managed') %>% 
ggplot() + 
  geom_point(aes(yr, bf/ave_annual_precip, group = site_id)) + 
  #stat_smooth(geom = 'line',aes(yr,bf, group = site_id), method = 'lm', se = F, alpha = 0.5, size = 1) +
  geom_smooth(aes(yr, bf/ave_annual_precip), method = 'lm') +
  scale_y_log10() +
  scale_color_gradientn(colors = hcl.colors('Zissou1', n = 11)) +
  facet_nested(. ~ MAP_UNIT_N+shed_cut+harv_group, rows = var,
               nest_line = element_line(linetype = 1, size = 2)) +
  custom_theme() + 
  labs(x = 'Sample Year', y = 'Bankfull Width (m)/ Ave Annual Precip (mm)',
       title = 'Faceted by Watershed Area km2 and Harvest Groups')

harv_3d <- plot_ly(gr_95_ts,
        x = ~shed_areakm2, 
        y = ~ave_annual_precip,
        z = ~bf,
        stroke = 2,
        type="scatter3d",
        mode="markers",
        color=gr_95_ts$harv_group)

add_trace(p = harv_3d,
          z = petal_lm_surface,
          x = axis_x,
          y = axis_y,
          type = "surface")

pibo_sites %>% filter(MAP_UNIT_N == 'Flathead Valley') %>% mapview::mapview(zcol = 'higher_than_30')
  ggplot() + geom_sf(aes(color = higher_than_30))
```

















